varnishtest "Test xcounter vmod"

server s1 {
       rxreq
       txresp
} -start

varnish v1 -vcl+backend {
	import std;
	import ${vmod_xcounter};

	sub vcl_init {
		new example_net_200 = xcounter.vsc(
			format   = duration,
			type     = counter,
			level    = info,
			oneliner = "hello"
			
			);
		new example_net_400 = xcounter.vsc();
	}

	sub vcl_deliver {
		example_net_200.set(1);
		example_net_400.set(100);
		example_net_400.incr(1);
		example_net_400.incr(2);
		example_net_400.incr(3);
		example_net_400.decr(1);
		set resp.http.e400 = example_net_400.get();
		set resp.http.e200 = example_net_200.get();
	}

} -start

client c1 {
	txreq -url "/"
	rxresp
	expect resp.http.e400  ==  "105"
	expect resp.http.e200  ==  "1"
}

client c1 -run
varnish v1 -expect XCNT.vcl1.example_net_200.val == 1
varnish v1 -expect XCNT.vcl1.example_net_400.val == 105
#shell "varnishstat -1 -n ${v1_name} > /tmp/foo"
